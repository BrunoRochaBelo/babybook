var Z=Object.defineProperty;var v=o=>{throw TypeError(o)};var tt=(o,f,p)=>f in o?Z(o,f,{enumerable:!0,configurable:!0,writable:!0,value:p}):o[f]=p;var u=(o,f,p)=>tt(o,typeof f!="symbol"?f+"":f,p),F=(o,f,p)=>f.has(o)||v("Cannot "+p);var s=(o,f,p)=>(F(o,f,"read from private field"),p?p.call(o):f.get(o)),A=(o,f,p)=>f.has(o)?v("Cannot add the same private member more than once"):f instanceof WeakSet?f.add(o):f.set(o,p),S=(o,f,p,B)=>(F(o,f,"write to private field"),B?B.call(o,p):f.set(o,p),p);(function(){"use strict";var R,L,D,I,U,$,E;var o;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(o||(o={}));const f=(()=>{let t=0;return()=>t++})(),p=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),B=new Error("called FFmpeg.terminate()");class x{constructor(){A(this,R,null);A(this,L,{});A(this,D,{});A(this,I,[]);A(this,U,[]);u(this,"loaded",!1);A(this,$,()=>{s(this,R)&&(s(this,R).onmessage=({data:{id:e,type:r,data:a}})=>{switch(r){case o.LOAD:this.loaded=!0,s(this,L)[e](a);break;case o.MOUNT:case o.UNMOUNT:case o.EXEC:case o.FFPROBE:case o.WRITE_FILE:case o.READ_FILE:case o.DELETE_FILE:case o.RENAME:case o.CREATE_DIR:case o.LIST_DIR:case o.DELETE_DIR:s(this,L)[e](a);break;case o.LOG:s(this,I).forEach(i=>i(a));break;case o.PROGRESS:s(this,U).forEach(i=>i(a));break;case o.ERROR:s(this,D)[e](a);break}delete s(this,L)[e],delete s(this,D)[e]})});A(this,E,({type:e,data:r},a=[],i)=>s(this,R)?new Promise((n,w)=>{const c=f();s(this,R)&&s(this,R).postMessage({id:c,type:e,data:r},a),s(this,L)[c]=n,s(this,D)[c]=w,i==null||i.addEventListener("abort",()=>{w(new DOMException(`Message # ${c} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(p));u(this,"load",({classWorkerURL:e,...r}={},{signal:a}={})=>(s(this,R)||(S(this,R,e?new Worker(new URL(e,self.location.href),{type:"module"}):new Worker(new URL("/assets/worker-BAOIWoxA.js",self.location.href),{type:"module"})),s(this,$).call(this)),s(this,E).call(this,{type:o.LOAD,data:r},void 0,a)));u(this,"exec",(e,r=-1,{signal:a}={})=>s(this,E).call(this,{type:o.EXEC,data:{args:e,timeout:r}},void 0,a));u(this,"ffprobe",(e,r=-1,{signal:a}={})=>s(this,E).call(this,{type:o.FFPROBE,data:{args:e,timeout:r}},void 0,a));u(this,"terminate",()=>{const e=Object.keys(s(this,D));for(const r of e)s(this,D)[r](B),delete s(this,D)[r],delete s(this,L)[r];s(this,R)&&(s(this,R).terminate(),S(this,R,null),this.loaded=!1)});u(this,"writeFile",(e,r,{signal:a}={})=>{const i=[];return r instanceof Uint8Array&&i.push(r.buffer),s(this,E).call(this,{type:o.WRITE_FILE,data:{path:e,data:r}},i,a)});u(this,"mount",(e,r,a)=>{const i=[];return s(this,E).call(this,{type:o.MOUNT,data:{fsType:e,options:r,mountPoint:a}},i)});u(this,"unmount",e=>{const r=[];return s(this,E).call(this,{type:o.UNMOUNT,data:{mountPoint:e}},r)});u(this,"readFile",(e,r="binary",{signal:a}={})=>s(this,E).call(this,{type:o.READ_FILE,data:{path:e,encoding:r}},void 0,a));u(this,"deleteFile",(e,{signal:r}={})=>s(this,E).call(this,{type:o.DELETE_FILE,data:{path:e}},void 0,r));u(this,"rename",(e,r,{signal:a}={})=>s(this,E).call(this,{type:o.RENAME,data:{oldPath:e,newPath:r}},void 0,a));u(this,"createDir",(e,{signal:r}={})=>s(this,E).call(this,{type:o.CREATE_DIR,data:{path:e}},void 0,r));u(this,"listDir",(e,{signal:r}={})=>s(this,E).call(this,{type:o.LIST_DIR,data:{path:e}},void 0,r));u(this,"deleteDir",(e,{signal:r}={})=>s(this,E).call(this,{type:o.DELETE_DIR,data:{path:e}},void 0,r))}on(e,r){e==="log"?s(this,I).push(r):e==="progress"&&s(this,U).push(r)}off(e,r){e==="log"?S(this,I,s(this,I).filter(a=>a!==r)):e==="progress"&&S(this,U,s(this,U).filter(a=>a!==r))}}R=new WeakMap,L=new WeakMap,D=new WeakMap,I=new WeakMap,U=new WeakMap,$=new WeakMap,E=new WeakMap;var T;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(T||(T={}));const C=new Error("failed to get response body reader"),W=new Error("failed to complete download"),j="Content-Length",z=t=>new Promise((e,r)=>{const a=new FileReader;a.onload=()=>{const{result:i}=a;i instanceof ArrayBuffer?e(new Uint8Array(i)):e(new Uint8Array)},a.onerror=i=>{var n,w;r(Error(`File could not be read! Code=${((w=(n=i==null?void 0:i.target)==null?void 0:n.error)==null?void 0:w.code)||-1}`))},a.readAsArrayBuffer(t)}),k=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(r=>r.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await z(t);else return new Uint8Array;return new Uint8Array(e)},q=async(t,e)=>{var i;const r=await fetch(t);let a;try{const n=parseInt(r.headers.get(j)||"-1"),w=(i=r.body)==null?void 0:i.getReader();if(!w)throw C;const c=[];let l=0;for(;;){const{done:g,value:O}=await w.read(),_=O?O.length:0;if(g){if(n!=-1&&n!==l)throw W;e&&e({url:t,total:n,received:l,delta:_,done:g});break}c.push(O),l+=_,e&&e({url:t,total:n,received:l,delta:_,done:g})}const h=new Uint8Array(l);let m=0;for(const g of c)h.set(g,m),m+=g.length;a=h.buffer}catch(n){console.log("failed to send download progress event: ",n),a=await r.arrayBuffer()}return a},P=async(t,e,r=!1,a)=>{const i=r?await q(t,a):await(await fetch(t)).arrayBuffer(),n=new Blob([i],{type:e});return URL.createObjectURL(n)},G={"720p":{width:1280,height:720,bitrate:"2500k"},"1080p":{width:1920,height:1080,bitrate:"5000k"},"480p":{width:854,height:480,bitrate:"1500k"}},X={high:{crf:18,preset:"slow"},medium:{crf:23,preset:"medium"},low:{crf:28,preset:"fast"}};let d=null,N=!1;const b=new Map;async function Y(){if(!(N&&d)){d=new x,d.on("progress",({progress:t})=>{b.forEach((e,r)=>{e.aborted||postMessage({type:"progress",id:r,progress:Math.min(t*100,100),stage:"processing"})})}),d.on("log",({message:t})=>{console.log("[ffmpeg]",t)});try{const t=["https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm","https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm"];let e=null;for(const r of t)try{const a=await P(`${r}/ffmpeg-core.js`,"text/javascript"),i=await P(`${r}/ffmpeg-core.wasm`,"application/wasm");await d.load({coreURL:a,wasmURL:i}),e=null;break}catch(a){e=a}if(e)throw e;N=!0,postMessage({type:"ready",id:"init"})}catch(t){throw new Error(`Failed to initialize ffmpeg: ${t}`)}}}async function H(t,e){if(!d||!N)throw new Error("ffmpeg not initialized");const r={aborted:!1};b.set(t,r);try{const{file:a,targetResolution:i,format:n,quality:w}=e,c=G[i],l=X[w];postMessage({type:"progress",id:t,progress:0,stage:"loading"});const h=`input_${t}.${a.name.split(".").pop()}`,m=`output_${t}.${n}`;if(await d.writeFile(h,await k(a)),r.aborted){await y(h,m);return}postMessage({type:"progress",id:t,progress:10,stage:"transcoding"});const g=["-i",h,"-vf",`scale=${c.width}:${c.height}:force_original_aspect_ratio=decrease,pad=${c.width}:${c.height}:(ow-iw)/2:(oh-ih)/2`,"-c:v",n==="webm"?"libvpx-vp9":"libx264","-crf",String(l.crf),"-preset",l.preset,"-b:v",c.bitrate,"-c:a",n==="webm"?"libopus":"aac","-b:a","128k","-movflags","+faststart","-y",m];if(await d.exec(g),r.aborted){await y(h,m);return}const O=await d.readFile(m),_=O instanceof Uint8Array?new Uint8Array(O):new TextEncoder().encode(O),M=new Blob([_],{type:n==="webm"?"video/webm":"video/mp4"}),V={width:c.width,height:c.height,size:M.size,codec:n==="webm"?"vp9":"h264"};await y(h,m),b.delete(t),postMessage({type:"complete",id:t,result:M,metadata:V})}catch(a){throw b.delete(t),a}}async function J(t,e){if(!d||!N)throw new Error("ffmpeg not initialized");const r={aborted:!1};b.set(t,r);try{const{file:a,timeSeconds:i,width:n,height:w}=e,c=`input_${t}.${a.name.split(".").pop()}`,l=`thumb_${t}.jpg`;if(await d.writeFile(c,await k(a)),r.aborted){await y(c,l);return}if(await d.exec(["-ss",String(i),"-i",c,"-vf",`scale=${n}:${w}:force_original_aspect_ratio=decrease`,"-frames:v","1","-q:v","2","-y",l]),r.aborted){await y(c,l);return}const h=await d.readFile(l),m=h instanceof Uint8Array?new Uint8Array(h):new TextEncoder().encode(h),g=new Blob([m],{type:"image/jpeg"});await y(c,l),b.delete(t),postMessage({type:"complete",id:t,result:g,metadata:{width:n,height:w,size:g.size}})}catch(a){throw b.delete(t),a}}async function K(t,e){if(!d||!N)throw new Error("ffmpeg not initialized");const r={aborted:!1};b.set(t,r);try{const{file:a,maxWidth:i,maxHeight:n,quality:w,format:c}=e,l=`input_${t}.${a.name.split(".").pop()}`,h=`output_${t}.${c}`;if(await d.writeFile(l,await k(a)),r.aborted){await y(l,h);return}if(await d.exec(["-i",l,"-vf",`scale='min(${i},iw)':min'(${n},ih)':force_original_aspect_ratio=decrease`,"-q:v",String(Math.round((100-w)/10)+1),"-y",h]),r.aborted){await y(l,h);return}const m=await d.readFile(h),g=c==="webp"?"image/webp":c==="png"?"image/png":"image/jpeg",O=m instanceof Uint8Array?new Uint8Array(m):new TextEncoder().encode(m),_=new Blob([O],{type:g});await y(l,h),b.delete(t),postMessage({type:"complete",id:t,result:_,metadata:{width:i,height:n,size:_.size}})}catch(a){throw b.delete(t),a}}async function y(...t){if(d)for(const e of t)try{await d.deleteFile(e)}catch{}}function Q(t){const e=b.get(t);e&&(e.aborted=!0,b.delete(t),postMessage({type:"error",id:t,error:"Job aborted"}))}self.onmessage=async t=>{const{type:e,id:r,payload:a}=t.data;try{switch(e){case"init":await Y();break;case"transcode":if(!a)throw new Error("Payload required for transcode");await H(r,a);break;case"thumbnail":if(!a)throw new Error("Payload required for thumbnail");await J(r,a);break;case"optimize":if(!a)throw new Error("Payload required for optimize");await K(r,a);break;case"abort":Q(r);break;default:throw new Error(`Unknown message type: ${e}`)}}catch(i){postMessage({type:"error",id:r,error:i instanceof Error?i.message:String(i)})}}})();
